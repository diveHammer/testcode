# Helper function to convert DN to readable OU path
function Convert-DNToOUPath {
    param ($dn)

    $parts = $dn -split ','
    $ouParts = $parts | Where-Object { $_ -like 'OU=*' } | ForEach-Object { $_ -replace '^OU=' }
    [Array]::Reverse($ouParts)
    return $ouParts -join '/'
}

# Initialize GPO list
$linkedGPOs = @()

foreach ($ouItem in $ouList) {
    $gpoLinks = Get-GPInheritance -Target $ouItem.DistinguishedName
    $ouPath = Convert-DNToOUPath -dn $ouItem.DistinguishedName

    foreach ($gpo in $gpoLinks.GpoLinks) {
        $linkedGPOs += [PSCustomObject]@{
            OU_Name         = $ouItem.Name
            OU_Path         = $ouPath
            OU_DN           = $ouItem.DistinguishedName
            GPO_Name        = $gpo.DisplayName
            Enforced        = $gpo.Enforced
            Source_URL      = $customURL
        }
    }
}
