# Load required modules
Import-Module GroupPolicy -ErrorAction Stop
Import-Module ActiveDirectory -ErrorAction Stop

# Define domain
$DomainName = "lab.tx.dev.primarchadept.com"

# Generate timestamp for filename
$Timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm"
$OutputPath = "C:\GPO_Link_Report_$Timestamp.csv"

# Get all GPOs starting with "_HOTLAB"
$HotlabGPOs = Get-GPO -All -Domain $DomainName | Where-Object { $_.DisplayName -like "_HOTLAB*" }

# Create a hashtable for quick GPO lookup by GUID
$GPOMap = @{}
foreach ($gpo in $HotlabGPOs) {
    $GPOMap[$gpo.Id.Guid] = $gpo.DisplayName
}

# Initialize results array
$Results = @()

# Get all OUs in the domain
$OUs = Get-ADOrganizationalUnit -Filter * -Properties gPLink -Server $DomainName

# Loop through each GPO
foreach ($gpo in $HotlabGPOs) {
    Write-Host "`nüîç Scanning GPO: $($gpo.DisplayName)" -ForegroundColor Cyan

    foreach ($OU in $OUs) {
        $gpLinksRaw = $OU.gPLink
        if (![string]::IsNullOrEmpty($gpLinksRaw)) {
            $gpLinksRaw -split '

\[LDAP://|;]' | Where-Object { $_ -match '^CN=.+?{(.+?)}' } | ForEach-Object {
                $guid = $_ -replace '^CN=.+?{(.+?)}.*$', '$1'
                try {
                    $gpoGuid = [Guid]$guid
                    if ($gpoGuid -eq $gpo.Id.Guid) {
                        $formattedOU = "$DomainName\" + ($OU.DistinguishedName -replace '^OU=', '' -replace ',OU=', '\' -replace ',DC=.*$', '')
                        Write-Host "   ‚Ü≥ Linked to OU: $formattedOU" -ForegroundColor Yellow

                        $Results += [PSCustomObject]@{
                            GPOName  = $gpo.DisplayName
                            LinkedOU = $formattedOU
                        }
                    }
                } catch {
                    Write-Warning "Invalid GUID format: $guid"
                }
            }
        }
    }
}

# Export results to timestamped CSV
$Results | Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8

Write-Host "`n‚úÖ GPO link report saved to $OutputPath" -ForegroundColor Green
