function Get-GPOLinkedOUs {
    [CmdletBinding()]
    param (
        [Parameter(Mandatory=$true)]
        [Guid]$GpoGuid,

        [Parameter(Mandatory=$true)]
        [string]$DomainName
    )

    # Load required module
    Import-Module ActiveDirectory -ErrorAction Stop

    # Get all OUs in the domain
    $OUs = Get-ADOrganizationalUnit -Filter * -Properties gPLink -Server $DomainName

    $LinkedOUs = @()

    foreach ($OU in $OUs) {
        $gpLinksRaw = $OU.gPLink
        if (![string]::IsNullOrEmpty($gpLinksRaw)) {
            $gpLinksRaw -split '

\[LDAP://|;]' | Where-Object { $_ -match '^CN=.+?{(.+?)}' } | ForEach-Object {
                $guid = $_ -replace '^CN=.+?{(.+?)}.*$', '$1'
                try {
                    $linkedGuid = [Guid]$guid
                    if ($linkedGuid -eq $GpoGuid) {
                        $formattedOU = "$DomainName\" + ($OU.DistinguishedName -replace '^OU=', '' -replace ',OU=', '\' -replace ',DC=.*$', '')
                        $LinkedOUs += $formattedOU
                    }
                } catch {
                    Write-Warning "Invalid GUID format: $guid"
                }
            }
        }
    }

    return $LinkedOUs
}
