# Load required modules
Import-Module GroupPolicy -ErrorAction Stop
Import-Module ActiveDirectory -ErrorAction Stop

# Define domain and output path
$DomainName = "lab.tx.dev.primarchadept.com"
$OutputPath = "C:\GPO_Link_Report.csv"

# Get all GPOs starting with "_HOTLAB"
$HotlabGPOs = Get-GPO -All -Domain $DomainName | Where-Object { $_.DisplayName -like "_HOTLAB*" }

# Create a hashtable for quick GPO lookup by GUID
$GPOMap = @{}
foreach ($gpo in $HotlabGPOs) {
    $GPOMap[$gpo.Id.Guid] = $gpo.DisplayName
}

# Initialize results array
$Results = @()

# Get all OUs in the domain
$OUs = Get-ADOrganizationalUnit -Filter * -Properties gPLink -Server $DomainName

foreach ($OU in $OUs) {
    $gpLinksRaw = $OU.gPLink
    if (![string]::IsNullOrEmpty($gpLinksRaw)) {
        Write-Host "üîç Scanning OU: $($OU.Name)" -ForegroundColor Magenta

        $gpLinksRaw -split '

\[LDAP://|;]' | Where-Object { $_ -match '^CN=.+?{(.+?)}' } | ForEach-Object {
            $guid = $_ -replace '^CN=.+?{(.+?)}.*$', '$1'
            try {
                $gpoGuid = [Guid]$guid
                if ($GPOMap.ContainsKey($gpoGuid)) {
                    Write-Host "   ‚Ü≥ Linked GPO: $($GPOMap[$gpoGuid])" -ForegroundColor Magenta

                    $formattedOU = "$DomainName\" + ($OU.DistinguishedName -replace '^OU=', '' -replace ',OU=', '\' -replace ',DC=.*$', '')
                    $Results += [PSCustomObject]@{
                        GPOName  = $GPOMap[$gpoGuid]
                        LinkedOU = $formattedOU
                    }
                }
            } catch {
                Write-Warning "Invalid GUID format: $guid"
            }
        }
    }
}

# Export results to CSV
$Results | Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8

Write-Host "`n‚úÖ GPO link report saved to $OutputPath" -ForegroundColor Green
