# Load required module
Import-Module GroupPolicy -ErrorAction Stop

# Define domain and output path
$DomainName = "lab.tx.dev.primarchadept.com"
$OutputPath = "C:\GPO_Link_Report.csv"

# Retrieve all GPOs in the domain
$AllGPOs = Get-GPO -All -Domain $DomainName

# Filter GPOs starting with "_HOTLAB"
$HotlabGPOs = $AllGPOs | Where-Object { $_.DisplayName -like "_HOTLAB*" }

# Initialize result array
$Results = @()

# Loop through each matching GPO
foreach ($GPO in $HotlabGPOs) {
    # Get links for the GPO
    $Links = Get-GPOLink -Guid $GPO.Id -Domain $DomainName

    foreach ($Link in $Links) {
        # Format the OU path
        $OUPath = $Link.Target.Replace("LDAP://", "").Replace(",", "\").Replace("OU=", "").Replace("DC=", "")
        $FormattedOU = "$DomainName\$OUPath"

        # Add to results
        $Results += [PSCustomObject]@{
            GPOName = $GPO.DisplayName
            LinkedOU = $FormattedOU
        }
    }
}

# Export to CSV
$Results | Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8

Write-Host "GPO link report saved to $OutputPath"
