function Get-GPOLinks {
    [CmdletBinding()]
    param (
        [Parameter(Mandatory = $true)]
        [string]$GPOName
    )

    # Load modules
    Import-Module GroupPolicy -ErrorAction Stop
    Import-Module ActiveDirectory -ErrorAction Stop

    # Get GPO object
    try {
        $GPO = Get-GPO -Name $GPOName -ErrorAction Stop
    }
    catch {
        Write-Host "GPO '$GPOName' not found." -ForegroundColor Red
        return
    }

    # Output header
    Write-Host "`nGPO:" -ForegroundColor Green -NoNewline
    Write-Host " $($GPO.DisplayName)" -ForegroundColor Green

    # Prepare timestamp and CSV
    $Timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
    $OutputPath = ".\GPO_Link_Report_$($Timestamp).csv"

    # Search OUs with gPLink attribute referencing this GPO’s GUID
    $GUID = $GPO.Id.Guid
    $LinkedOUs = Get-ADOrganizationalUnit -LDAPFilter "(gPLink=*$GUID*)" -Properties gPLink -ErrorAction SilentlyContinue

    $Results = @()

    foreach ($OU in $LinkedOUs) {
        Write-Host "  Linked To: $($OU.DistinguishedName)" -ForegroundColor Green

        # Detect if link is enforced (look for “2” in gPLink value)
        $IsEnforced = if ($OU.gPLink -match "[$GUID];[0-9]+;[0-9]+;[0-9]+;[0-9]+;[0-9]+;[0-9]+;2") { $true } else { $false }

        $Results += [PSCustomObject]@{
            GPOName  = $GPO.DisplayName
            LinkedTo = $OU.DistinguishedName
            Enabled  = $true
            Enforced = $IsEnforced
        }
    }

    # Include domain root if linked
    $Domain = (Get-ADDomain).DistinguishedName
    $DomainObj = Get-ADObject -Identity $Domain -Properties gPLink -ErrorAction SilentlyContinue
    if ($DomainObj.gPLink -match $GUID) {
        Write-Host "  Linked To (Domain): $Domain" -ForegroundColor Green
        $Results += [PSCustomObject]@{
            GPOName  = $GPO.DisplayName
            LinkedTo = $Domain
            Enabled  = $true
            Enforced = ($DomainObj.gPLink -match ";2")
        }
    }

    if ($Results.Count -eq 0) {
        Write-Host "No OUs or domain roots linked to this GPO." -ForegroundColor Yellow
    }
    else {
        $Results | Export-Csv -Path $OutputPath -NoTypeInformation -Encoding UTF8
        Write-Host "`nResults exported to $OutputPath" -ForegroundColor Green
    }

    Write-Host "`nDone." -ForegroundColor Green
}
