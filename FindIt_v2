# Prompt for top-level OU name
$ouInput = Read-Host "Enter the top-level OU name (e.g., OGRE)"

# Construct the reference URL
$customURL = "lab.us.darkrun.com/IMP/$ouInput"
Write-Host "üîó Using URL: $customURL" -ForegroundColor Cyan

# Define output folder
$basePath = "C:\Temp\GPO-Backup\$ouInput"
if (-not (Test-Path $basePath)) {
    New-Item -ItemType Directory -Path $basePath -Force | Out-Null
    Write-Host "üìÅ Created folder: $basePath"
}

# Define file paths
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$gpoCsvPath = Join-Path $basePath "GPO_List_$timestamp.csv"
$ouCsvPath  = Join-Path $basePath "OU_List_$timestamp.csv"
$exportPath = Join-Path $basePath "GPO_Exports"
New-Item -ItemType Directory -Path $exportPath -Force | Out-Null

# Get the full DN of the top-level OU
$topOU = Get-ADOrganizationalUnit -Filter "Name -eq '$ouInput'" -Properties DistinguishedName
if (-not $topOU) {
    Write-Host "‚ùå Top-level OU '$ouInput' not found." -ForegroundColor Red
    exit
}

$topOUDN = $topOU.DistinguishedName

# Recursively get all sub-OUs under the top-level OU
$ouList = Get-ADOrganizationalUnit -Filter * -SearchBase $topOUDN -SearchScope Subtree -Properties Name, DistinguishedName

# Include the top-level OU itself
$ouList += $topOU

# Write OU list to CSV
$ouList | Select-Object Name, DistinguishedName | Export-Csv -Path $ouCsvPath -NoTypeInformation
Write-Host "üìÑ OU list saved to: $ouCsvPath" -ForegroundColor Green

# Initialize GPO list
$linkedGPOs = @()

foreach ($ouItem in $ouList) {
    $gpoLinks = Get-GPInheritance -Target $ouItem.DistinguishedName
    foreach ($gpo in $gpoLinks.GpoLinks) {
        $linkedGPOs += [PSCustomObject]@{
            OU              = $ouItem.Name
            OU_DN           = $ouItem.DistinguishedName
            GPO_Name        = $gpo.DisplayName
            Enforced        = $gpo.Enforced
            Source_URL      = $customURL
        }
    }
}

# Write GPO list to CSV
$linkedGPOs | Export-Csv -Path $gpoCsvPath -NoTypeInformation
Write-Host "‚úÖ GPO list saved to: $gpoCsvPath" -ForegroundColor Green

# Export each unique GPO
foreach ($gpoEntry in $linkedGPOs | Select-Object -Unique GPO_Name) {
    $gpoName = $gpoEntry.GPO_Name
    try {
        $gpo = Get-GPO -Name $gpoName -ErrorAction Stop
        Backup-GPO -Guid $gpo.Id -Path $exportPath -ErrorAction Stop | Out-Null
        Write-Host "üì¶ Exported GPO: $gpoName"
    } catch {
        Write-Host "‚ö†Ô∏è Failed to export GPO: $gpoName" -ForegroundColor Yellow
    }
}

Write-Host "`nüéâ Script completed. All files saved under: $basePath" -ForegroundColor Cyan
Write-Host "üîó Reference URL: $customURL" -ForegroundColor Cyan
